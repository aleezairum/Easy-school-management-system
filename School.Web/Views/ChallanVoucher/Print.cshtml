@{
    Layout = null;
    var challanId = ViewData["ChallanId"];
}

<!DOCTYPE html>
<html>
<head>
    <title>Fee Challan</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; font-size: 12px; padding: 20px; }
        .challan { border: 2px solid #000; padding: 20px; max-width: 800px; margin: 0 auto; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 15px; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header h2 { font-size: 16px; font-weight: normal; }
        .challan-no { text-align: right; font-size: 14px; font-weight: bold; margin-bottom: 15px; }
        .info-row { display: flex; margin-bottom: 10px; }
        .info-row .label { width: 120px; font-weight: bold; }
        .info-row .value { flex: 1; border-bottom: 1px dotted #000; padding-left: 10px; }
        .fee-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .fee-table th, .fee-table td { border: 1px solid #000; padding: 8px; text-align: left; }
        .fee-table th { background: #f0f0f0; }
        .fee-table .amount { text-align: right; }
        .total-row { font-weight: bold; background: #e0e0e0; }
        .footer { margin-top: 30px; display: flex; justify-content: space-between; }
        .signature { width: 200px; text-align: center; }
        .signature-line { border-top: 1px solid #000; margin-top: 50px; padding-top: 5px; }
        .print-btn { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #008649; color: white; border: none; cursor: pointer; border-radius: 5px; }
        @@media print { .print-btn { display: none; } }
    </style>
</head>
<body>
    <button class="print-btn" onclick="window.print()">Print Challan</button>

    <div class="challan" id="challanContent">
        <div class="header">
            <h1>SCHOOL NAME</h1>
            <h2>Fee Challan</h2>
        </div>

        <div class="challan-no">
            Challan No: <span id="challanNumber">-</span>
        </div>

        <div class="info-row">
            <span class="label">Student Name:</span>
            <span class="value" id="studentName">-</span>
        </div>
        <div class="info-row">
            <span class="label">Roll Number:</span>
            <span class="value" id="rollNumber">-</span>
        </div>
        <div class="info-row">
            <span class="label">Class / Section:</span>
            <span class="value" id="classSection">-</span>
        </div>
        <div class="info-row">
            <span class="label">Issue Date:</span>
            <span class="value" id="issueDate">-</span>
        </div>
        <div class="info-row">
            <span class="label">Due Date:</span>
            <span class="value" id="dueDate">-</span>
        </div>

        <table class="fee-table">
            <thead>
                <tr>
                    <th>Fee Type</th>
                    <th class="amount">Amount</th>
                </tr>
            </thead>
            <tbody id="feeDetails">
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td>Total Amount</td>
                    <td class="amount" id="totalAmount">0.00</td>
                </tr>
            </tfoot>
        </table>

        <div class="footer">
            <div class="signature">
                <div class="signature-line">Parent/Guardian</div>
            </div>
            <div class="signature">
                <div class="signature-line">Accountant</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5266/api';
        const challanId = @(challanId ?? 0);

        document.addEventListener('DOMContentLoaded', function() {
            if (challanId > 0) {
                loadChallan();
            }
        });

        async function loadChallan() {
            try {
                const response = await fetch(`${API_BASE}/ChallanVoucher/${challanId}`);
                if (response.ok) {
                    const data = await response.json();
                    displayChallan(data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function displayChallan(data) {
            document.getElementById('challanNumber').textContent = data.challanNumber;
            document.getElementById('studentName').textContent = data.studentName || '-';
            document.getElementById('rollNumber').textContent = data.rollNumber || '-';
            document.getElementById('classSection').textContent = `${data.className || ''} / ${data.sectionName || ''}`;
            document.getElementById('issueDate').textContent = formatDate(data.issueDate);
            document.getElementById('dueDate').textContent = formatDate(data.dueDate);

            const fees = [
                { name: 'Tuition Fee', amount: data.tuitionFee },
                { name: 'Admission Fee', amount: data.admissionFee },
                { name: 'Exam Fee', amount: data.examFee },
                { name: 'Transport Fee', amount: data.transportFee },
                { name: 'Lab Fee', amount: data.labFee },
                { name: 'Library Fee', amount: data.libraryFee },
                { name: 'Sports Fee', amount: data.sportsFee },
                { name: 'Computer Fee', amount: data.computerFee },
                { name: 'Other Fee', amount: data.otherFee },
                { name: 'Arrears', amount: data.arrearsAmount },
                { name: 'Discount', amount: -data.discount },
                { name: 'Late Fee', amount: data.lateFee }
            ].filter(f => f.amount !== 0);

            const tbody = document.getElementById('feeDetails');
            fees.forEach(fee => {
                tbody.innerHTML += `<tr><td>${fee.name}</td><td class="amount">${fee.amount.toFixed(2)}</td></tr>`;
            });

            document.getElementById('totalAmount').textContent = data.totalAmount.toFixed(2);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }
    </script>
</body>
</html>
